{%- assign related_cat2 = "" | split: "" -%}
{%- assign related_cat1_tag2 = "" | split: "" -%}
{%- assign related_cat1_tag1 = "" | split: "" -%}
{%- assign related_posts = "" | split: "" -%}

{%- assign page_tags = page.tags | default: "" -%}
{%- assign page_cats = page.categories | default: "" -%}

{% for post in site.posts %}
  {% if post.id == page.id %}
    {% continue %}
  {% endif %}

  {%- assign post_tags = post.tags | default: "" -%}
  {%- assign post_cats = post.categories | default: "" -%}

  {%- assign cat_match = 0 -%}
  {% for c in page_cats %}
    {% if post_cats contains c %}
      {%- assign cat_match = cat_match | plus: 1 -%}
    {% endif %}
  {% endfor %}

  {% if cat_match == 0 %}
    {% continue %}
  {% endif %}

  {%- assign tag_match = 0 -%}
  {% for t in page_tags %}
    {% if post_tags contains t %}
      {%- assign tag_match = tag_match | plus: 1 -%}
    {% endif %}
  {% endfor %}

  {% if cat_match >= 2 %}
    {%- assign related_cat2 = related_cat2 | push: post -%}
  {% elsif cat_match == 1 and tag_match >= 2 %}
    {%- assign related_cat1_tag2 = related_cat1_tag2 | push: post -%}
  {% elsif cat_match == 1 and tag_match == 1 %}
    {%- assign related_cat1_tag1 = related_cat1_tag1 | push: post -%}
  {% endif %}
{% endfor %}

{%- assign related_posts = related_cat2
  | concat: related_cat1_tag2
  | concat: related_cat1_tag1
-%}

{% if related_posts.size < 4 %}
  {% for post in site.posts %}
    {% if post.id == page.id %}
      {% continue %}
    {% endif %}
    {% unless related_posts contains post %}
      {%- assign related_posts = related_posts | push: post -%}
    {% endunless %}
    {% if related_posts.size >= 4 %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="page__related">
  <h2 class="page__related-title">
    {{ site.data.ui-text[site.locale].related_label }}
  </h2>

  <div class="grid__wrapper">
    {% for post in related_posts limit:4 %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>
