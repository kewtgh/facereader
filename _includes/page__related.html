{%- assign strong = "" | split: "" -%}
{%- assign medium = "" | split: "" -%}
{%- assign fallback = "" | split: "" -%}
{%- assign related = "" | split: "" -%}

{%- assign page_categories = page.categories | default: "" -%}
{%- assign page_tags = page.tags | default: "" -%}

{% for post in site.posts %}
  {% if post.id == page.id %}{% continue %}{% endif %}

  {%- assign post_categories = post.categories | default: "" -%}
  {%- assign post_tags = post.tags | default: "" -%}

  {% assign cat_match = post_categories | intersection: page_categories | size %}
  {% assign tag_match = post_tags | intersection: page_tags | size %}

  {% if cat_match >= 2 %}
    {% assign strong = strong | push: post %}
  {% elsif cat_match == 1 and tag_match >= 2 %}
    {% assign medium = medium | push: post %}
  {% endif %}
{% endfor %}

{%- assign related = strong | concat: medium -%}

{%- comment -%}
  第三层兜底：从“社会杂论”分类补齐
{%- endcomment -%}

{% if related.size < 4 %}
  {% for post in site.posts %}
    {% if post.id == page.id %}{% continue %}{% endif %}

    {% if post.categories contains "社会杂论" %}
      {% unless related contains post %}
        {% assign fallback = fallback | push: post %}
      {% endunless %}
    {% endif %}
  {% endfor %}

  {% for post in fallback %}
    {% if related.size < 4 %}
      {% assign related = related | push: post %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="page__related">
  <h2 class="page__related-title">
    {{ site.data.ui-text[site.locale].related_label }}
  </h2>

  <div class="grid__wrapper">
    {% for post in related limit:4 %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>
