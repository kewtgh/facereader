{%- assign same_cat = "" | split: "" -%}
{%- assign social = "" | split: "" -%}
{%- assign related = "" | split: "" -%}

{%- assign main_cat = page.categories | first -%}

{% for post in site.posts %}
  {% if post.id == page.id %}{% continue %}{% endif %}

  {% if post.categories contains main_cat %}
    {% assign same_cat = same_cat | push: post %}
  {% endif %}

  {% if post.categories contains "社会杂论" %}
    {% assign social = social | push: post %}
  {% endif %}
{% endfor %}

{%- comment -%} 
  1. 取两篇同 Category（分散索引）
{%- endcomment -%}

{% if same_cat.size > 1 %}
  {% assign related = related | push: same_cat[1] %}
{% endif %}

{% if same_cat.size > 4 %}
  {% assign related = related | push: same_cat[4] %}
{% elsif same_cat.size > 2 %}
  {% assign related = related | push: same_cat[2] %}
{% endif %}

{%- comment -%}
  2. 取一篇社会杂论
{%- endcomment -%}

{% if social.size > 3 %}
  {% assign related = related | push: social[3] %}
{% elsif social.size > 0 %}
  {% assign related = related | push: social[0] %}
{% endif %}

{%- comment -%}
  3. 如果不足 4 篇，用同 Category 或全站补齐
{%- endcomment -%}

{% for post in site.posts %}
  {% if post.id == page.id %}{% continue %}{% endif %}
  {% unless related contains post %}
    {% assign related = related | push: post %}
  {% endunless %}
  {% if related.size >= 4 %}{% break %}{% endif %}
{% endfor %}

<div class="page__related">
  <h2 class="page__related-title">
    {{ site.data.ui-text[site.locale].related_label }}
  </h2>

  <div class="grid__wrapper">
    {% for post in related limit:4 %}
      {% include archive-single.html type="grid" %}
    {% endfor %}
  </div>
</div>
