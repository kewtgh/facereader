<script>
  function loadCSS(href) {
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = href;
    document.head.appendChild(link);
  }

  function loadScript(src) {
    return new Promise(function (resolve, reject) {
      var s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.body.appendChild(s);
    });
  }

  async function initSiteSearchOnce() {
    // 防重复初始化
    if (window.__FACEREADER_SITESEARCH_INITED__) return;
    window.__FACEREADER_SITESEARCH_INITED__ = true;

    // 确保容器存在
    var container = document.querySelector("#search");
    if (!container) {
      console.error("[SiteSearch] #search container not found. Check search_form.html.");
      window.__FACEREADER_SITESEARCH_INITED__ = false;
      return;
    }

    // 加载资源
    loadCSS("https://unpkg.com/@algolia/sitesearch@latest/dist/search.min.css");
    await loadScript("https://unpkg.com/@algolia/sitesearch@latest/dist/search.min.js");

    // 初始化
    SiteSearch.init({
      container: "#search",
      applicationId: "{{ site.algolia.application_id }}",
      apiKey: "{{ site.algolia.search_only_api_key }}",
      indexName: "{{ site.algolia.index_name }}",
      attributes: {
        primaryText: "{{ site.algolia.primary_text | default: 'title' }}",
        secondaryText: "{{ site.algolia.secondary_text | default: 'description' }}",
        tertiaryText: "{{ site.algolia.tertiary_text | default: 'content' }}",
        url: "{{ site.algolia.url_attribute | default: 'url' }}",
        image: "{{ site.algolia.image_attribute | default: 'image' }}" // 使用 default 来避免出错
      },
      darkMode: false,
      render: function(hits) {
        // 用默认图片或其他字段填充
        const defaultImage = "path/to/default/image.jpg"; // 设定默认图片路径

        const resultsList = document.querySelector(".search-results-list");
        resultsList.innerHTML = ""; // 清空之前的内容

        hits.forEach(hit => {
          const imageUrl = hit.image || defaultImage; // 如果没有 image 字段，使用默认图片
          const resultHTML = `
            <li class="search-result-item">
              <div class="result-item-left">
                <img src="${imageUrl}" alt="Teaser Image" class="result-item-image">
              </div>
              <div class="result-item-right">
                <h3><a href="${hit.url}">${hit._highlightResult.title.value}</a></h3>
                <p>${hit._highlightResult.description.value}</p>
              </div>
            </li>
          `;
          resultsList.innerHTML += resultHTML; // 动态添加每一条结果
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    var btn = document.querySelector(".search__toggle");
    if (!btn) return;

    btn.addEventListener("click", function () {
      initSiteSearchOnce().catch(function (e) {
        console.error("[SiteSearch] init failed:", e);
        window.__FACEREADER_SITESEARCH_INITED__ = false;
      });
    });
  });
</script>