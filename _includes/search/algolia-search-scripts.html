<script>
  function loadCSS(href) {
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = href;
    document.head.appendChild(link);
  }

  function loadScript(src) {
    return new Promise(function (resolve, reject) {
      var s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.body.appendChild(s);
    });
  }

  function escapeHTML(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  async function initAlgoliaInstantSearchOnce() {
    if (window.__FACEREADER_INSTANTSEARCH_INITED__) return;
    window.__FACEREADER_INSTANTSEARCH_INITED__ = true;

    var searchBoxEl = document.querySelector("#algolia-searchbox");
    var hitsEl = document.querySelector("#algolia-hits");
    if (!searchBoxEl || !hitsEl) {
      // 不在搜索页面就不初始化
      window.__FACEREADER_INSTANTSEARCH_INITED__ = false;
      return;
    }

    // InstantSearch 默认主题（你也可以自己全部重写）
    loadCSS("https://cdn.jsdelivr.net/npm/instantsearch.css@8/themes/satellite-min.css");

    // 加载依赖
    await loadScript("https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js");
    await loadScript("https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js");

    var appId = "{{ site.algolia.application_id }}";
    var apiKey = "{{ site.algolia.search_only_api_key }}";
    var indexName = "{{ site.algolia.index_name }}";

    var searchClient = algoliasearch(appId, apiKey);

    var search = instantsearch({
      indexName: indexName,
      searchClient: searchClient
    });

    search.addWidgets([
      instantsearch.widgets.searchBox({
        container: "#algolia-searchbox",
        placeholder: "搜索文章…",
        showReset: true,
        showSubmit: true,
        showLoadingIndicator: false
      }),

      instantsearch.widgets.configure({
        hitsPerPage: 10,
        attributesToSnippet: ["description:28"],
        snippetEllipsisText: "…"
      }),

      instantsearch.widgets.hits({
        container: "#algolia-hits",
        templates: {
          empty: function (data) {
            return `<div class="algolia-empty">没有找到「${escapeHTML(data.query)}」相关内容</div>`;
          },
          item: function (hit, { html, components }) {
            // teaser: 你推送的绝对地址字段
            var img = hit.teaser || "{{ '/assets/img/page-header-image-manufacture-teaser.jpg' | absolute_url }}";
            var titleHTML = (hit._highlightResult && hit._highlightResult.title && hit._highlightResult.title.value)
              ? hit._highlightResult.title.value
              : escapeHTML(hit.title);

            // 用 snippetResult.description（更干净），没有就 fallback 到 description
            var descHTML = (hit._snippetResult && hit._snippetResult.description && hit._snippetResult.description.value)
              ? hit._snippetResult.description.value
              : escapeHTML(hit.description || "");

            return `
              <article class="algolia-hit">
                <a class="algolia-hit__link" href="${escapeHTML(hit.url)}">
                  <div class="algolia-hit__media">
                    <img class="algolia-hit__img" src="${escapeHTML(img)}" alt="">
                  </div>
                  <div class="algolia-hit__body">
                    <h3 class="algolia-hit__title">${titleHTML}</h3>
                    <p class="algolia-hit__desc">${descHTML}</p>
                    <div class="algolia-hit__meta">
                      ${hit.date ? `<time datetime="${escapeHTML(hit.date)}">${escapeHTML(hit.date.slice(0,10))}</time>` : ""}
                    </div>
                  </div>
                </a>
              </article>
            `;
          }
        }
      }),

      instantsearch.widgets.pagination({
        container: "#algolia-pagination",
        padding: 2,
        showFirst: false,
        showLast: false
      })
    ]);

    search.start();

    // 支持 /search/?q=xxx 直接带入查询
    try {
      var params = new URLSearchParams(location.search);
      var q = params.get("q");
      if (q) {
        // InstantSearch 的 searchBox input 渲染后才能赋值，所以稍微延迟一下
        setTimeout(function () {
          var input = document.querySelector("#algolia-searchbox input[type='search']");
          if (input) {
            input.value = q;
            input.dispatchEvent(new Event("input", { bubbles: true }));
          }
        }, 0);
      }
    } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", function () {
    initAlgoliaInstantSearchOnce().catch(function (e) {
      console.error("[InstantSearch] init failed:", e);
      window.__FACEREADER_INSTANTSEARCH_INITED__ = false;
    });
  });
</script>